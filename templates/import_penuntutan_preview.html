{% extends "base.html" %}

{% block title %}Preview Import Data Penuntutan - Aplikasi Data PIDUM & PIDSUS{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h4><i class="fas fa-eye"></i> Preview Import Data Penuntutan</h4>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> Informasi File:</h6>
                    <p class="mb-0">
                        <strong>Nama File:</strong> {{ filename }}<br>
                        <strong>Total Data:</strong> {{ total_rows }} baris<br>
                        <strong>Tahapan:</strong> {{ tahapan_penanganan }}
                    </p>
                </div>

                <form method="POST" action="{{ url_for('confirm_import_penuntutan') }}" id="importForm">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm">
                            <thead class="table-dark">
                                <tr>
                                    <th width="50">No</th>
                                    <th width="120">Tanggal</th>
                                    <th width="80">Periode</th>
                                    <th>Register Perkara</th>
                                    <th>Identitas Tersangka</th>
                                    <th>Tindak Pidana</th>
                                    <th>Jaksa Penuntut</th>
                                    <th width="150">Jenis Perkara</th>
                                    <th width="60">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in import_data %}
                                <tr>
                                    <td>{{ row.NO }}</td>
                                    <td>
                                        <input type="date" name="tanggal_{{ loop.index0 }}" 
                                               value="{{ row.TANGGAL }}" class="form-control form-control-sm">
                                    </td>
                                    <td>
                                        <input type="number" name="periode_{{ loop.index0 }}" 
                                               value="{{ row.PERIODE }}" class="form-control form-control-sm" min="1">
                                    </td>
                                    <td>{{ row.NO_TANGGAL_REGISTER_ORIGINAL }}</td>
                                    <td>{{ row.IDENTITAS_TERSANGKA_ORIGINAL }}</td>
                                    <td>{{ row.TINDAK_PIDANA_ORIGINAL }}</td>
                                    <td>{{ row.JAKSA_PENUNTUT_UMUM_ORIGINAL }}</td>
                                    <td>
                                        <select name="jenis_perkara_{{ loop.index0 }}" class="form-select form-select-sm">
                                            <option value="NARKOBA" {% if row.SUGGESTED_JENIS_PERKARA == 'NARKOBA' %}selected{% endif %}>NARKOBA</option>
                                            <option value="PERKARA ANAK" {% if row.SUGGESTED_JENIS_PERKARA == 'PERKARA ANAK' %}selected{% endif %}>PERKARA ANAK</option>
                                            <option value="KESUSILAAN" {% if row.SUGGESTED_JENIS_PERKARA == 'KESUSILAAN' %}selected{% endif %}>KESUSILAAN</option>
                                            <option value="JUDI" {% if row.SUGGESTED_JENIS_PERKARA == 'JUDI' %}selected{% endif %}>JUDI</option>
                                            <option value="KDRT" {% if row.SUGGESTED_JENIS_PERKARA == 'KDRT' %}selected{% endif %}>KDRT</option>
                                            <option value="OHARDA" {% if row.SUGGESTED_JENIS_PERKARA == 'OHARDA' %}selected{% endif %}>OHARDA</option>
                                            <option value="PERKARA LAINNYA" {% if row.SUGGESTED_JENIS_PERKARA == 'PERKARA LAINNYA' %}selected{% endif %}>PERKARA LAINNYA</option>
                                        </select>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-danger" onclick="removeRow(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-between mt-3">
                        <a href="{{ url_for('import_tahapan', tahapan='penuntutan') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Kembali ke Upload
                        </a>
                        <div>
                            <button type="button" class="btn btn-warning me-2" onclick="selectAll()">
                                <i class="fas fa-check-square"></i> Pilih Semua
                            </button>
                            <button type="button" class="btn btn-info me-2" onclick="deselectAll()">
                                <i class="fas fa-square"></i> Hapus Pilihan
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Import Data
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function removeRow(button) {
    if (confirm('Apakah Anda yakin ingin menghapus baris ini?')) {
        var row = button.closest('tr');
        row.style.display = 'none';
        // Remove the jenis_perkara input to exclude from form submission
        var jenisPerkaraSelect = row.querySelector('select[name^="jenis_perkara_"]');
        if (jenisPerkaraSelect) {
            jenisPerkaraSelect.name = 'removed_' + jenisPerkaraSelect.name;
        }
    }
}

function selectAll() {
    var selects = document.querySelectorAll('select[name^="jenis_perkara_"]');
    selects.forEach(function(select) {
        select.disabled = false;
    });
}

function deselectAll() {
    var selects = document.querySelectorAll('select[name^="jenis_perkara_"]');
    selects.forEach(function(select) {
        select.disabled = true;
    });
}

// Form validation
document.getElementById('importForm').addEventListener('submit', function(e) {
    var activeSelects = document.querySelectorAll('select[name^="jenis_perkara_"]:not([disabled])');
    if (activeSelects.length === 0) {
        e.preventDefault();
        alert('Pilih setidaknya satu data untuk diimport!');
        return false;
    }
    
    // Enable all selects before form submission to ensure they're included
    var allSelects = document.querySelectorAll('select[name^="jenis_perkara_"]');
    allSelects.forEach(function(select) {
        select.disabled = false;
    });
    
    // Show loading indicator
    var submitBtn = document.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengimport...';
    }
});
</script>
{% endblock %}