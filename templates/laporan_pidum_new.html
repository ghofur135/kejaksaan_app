{% extends "base.html" %}

{% block title %}Laporan PIDUM per Tanggal - Aplikasi Data PIDUM & PIDSUS{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4><i class="fas fa-chart-line"></i> Laporan PIDUM per Tanggal</h4>
                <div>
                    <a href="{{ url_for('export_pidum_excel') }}" class="btn btn-success btn-sm">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </a>
                    <button onclick="window.print()" class="btn btn-info btn-sm">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Filter Section -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <form method="GET" class="row g-3">
                            <div class="col-md-2">
                                <label for="bulan" class="form-label">Bulan</label>
                                <select name="bulan" id="bulan" class="form-select">
                                    <option value="">Semua Bulan</option>
                                    {% for i in range(1, 13) %}
                                    <option value="{{ i }}" {% if bulan and bulan == i %}selected{% endif %}>
                                        {{ ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                                             'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'][i] }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="tahun" class="form-label">Tahun</label>
                                <select name="tahun" id="tahun" class="form-select">
                                    {% for year in range(2023, 2027) %}
                                    <option value="{{ year }}" {% if tahun and tahun == year %}selected{% endif %}>{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="periode" class="form-label">Periode</label>
                                <select name="periode" id="periode" class="form-select">
                                    <option value="">Semua Periode</option>
                                    {% for periode_opt in periode_options %}
                                    <option value="{{ periode_opt }}" {% if periode_filter and periode_filter == periode_opt %}selected{% endif %}>{{ periode_opt }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="start_date" class="form-label">Dari Tanggal</label>
                                <input type="date" name="start_date" id="start_date" class="form-control" value="{{ start_date or '' }}">
                            </div>
                            <div class="col-md-2">
                                <label for="end_date" class="form-label">Sampai Tanggal</label>
                                <input type="date" name="end_date" id="end_date" class="form-control" value="{{ end_date or '' }}">
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-filter"></i> Filter
                                </button>
                                <a href="{{ url_for('laporan_pidum_new') }}" class="btn btn-secondary">
                                    <i class="fas fa-refresh"></i> Reset
                                </a>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Summary Info -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> Informasi Laporan</h6>
                            <p class="mb-0">
                                <strong>Periode:</strong> 
                                {% if bulan %}
                                    {{ ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                                         'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'][bulan] }}
                                {% else %}
                                    Semua Bulan
                                {% endif %}
                                {{ tahun if tahun else '2025' }}
                                {% if start_date or end_date %}
                                    | <strong>Filter Tanggal:</strong>
                                    {% if start_date %}{{ start_date }}{% endif %}
                                    {% if start_date and end_date %} s/d {% endif %}
                                    {% if end_date %}{{ end_date }}{% endif %}
                                {% endif %}
                                | <strong>Total Kasus:</strong> {{ total_keseluruhan }} 
                                | <strong>Data per:</strong> {{ current_date }}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Table Section -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5><i class="fas fa-table"></i> Tabel Laporan</h5>
                            <div class="d-flex align-items-center">
                                <label for="entriesPerPage" class="form-label me-2 mb-0">Tampilkan:</label>
                                <select id="entriesPerPage" class="form-select form-select-sm" style="width: auto;">
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                    <option value="30">30</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                                <span class="ms-2">entri</span>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped" id="reportTable">
                                <thead class="table-light">
                                    <tr>
                                        <th width="4%" style="color: black;">No</th>
                                        <th width="12%" style="color: black;">Periode</th>
                                        <th width="12%" style="color: black;">Tanggal</th>
                                        <th width="20%" style="color: black;">Jenis Perkara</th>
                                        <th width="8%" style="color: black;">Total</th>
                                        <th width="12%" style="color: black;">Pra Penuntutan</th>
                                        <th width="12%" style="color: black;">Penuntutan</th>
                                        <th width="12%" style="color: black;">Upaya Hukum</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                    {% for item in report_data %}
                                    <tr>
                                        <td class="text-center">{{ loop.index }}</td>
                                        <td>
                                            {% if item.PERIODE %}
                                                <span class="badge bg-primary">{{ item.PERIODE }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Semua</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if item.TANGGAL %}
                                                <span class="badge bg-secondary">{{ item.TANGGAL }}</span>
                                            {% else %}
                                                <span class="badge bg-light text-dark">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ item.JENIS_PERKARA }}</span>
                                        </td>
                                        <td class="text-center">
                                            <strong class="text-primary">{{ item.TOTAL }}</strong>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-success">{{ item.PRA_PENUNTUTAN }}</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-warning">{{ item.PENUNTUTAN }}</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-danger">{{ item.UPAYA_HUKUM }}</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-secondary">
                                    <tr>
                                        <th colspan="4" class="text-center">TOTAL KESELURUHAN</th>
                                        <th class="text-center">{{ total_keseluruhan }}</th>
                                        <th class="text-center">{{ total_pra_penuntutan }}</th>
                                        <th class="text-center">{{ total_penuntutan }}</th>
                                        <th class="text-center">{{ total_upaya_hukum }}</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <!-- Pagination Controls -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div id="paginationInfo" class="text-muted">
                                Menampilkan 1 sampai 10 dari {{ report_data|length }} entri
                            </div>
                            <nav aria-label="Table pagination">
                                <ul class="pagination pagination-sm mb-0" id="paginationControls">
                                    <!-- Pagination akan di-generate oleh JavaScript -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- Chart Section -->
                <div class="row mt-5">
                    <div class="col-md-12">
                        <h5><i class="fas fa-chart-bar"></i> Grafik</h5>
                        
                        <!-- Chart by Jenis Perkara -->
                        <div class="row justify-content-center">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>Distribusi per Jenis Perkara</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="jenisPerkaraChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="row mt-4">
                    <div class="col-md-3">
                        <div class="card text-white bg-primary">
                            <div class="card-body text-center">
                                <h4>{{ total_keseluruhan }}</h4>
                                <p>Total Kasus</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-success">
                            <div class="card-body text-center">
                                <h4>{{ total_pra_penuntutan }}</h4>
                                <p>Pra Penuntutan</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-warning">
                            <div class="card-body text-center">
                                <h4>{{ total_penuntutan }}</h4>
                                <p>Penuntutan</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-danger">
                            <div class="card-body text-center">
                                <h4>{{ total_upaya_hukum }}</h4>
                                <p>Upaya Hukum</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Data for charts
const reportData = {{ report_data | tojson }};

// Pagination functionality
let currentPage = 1;
let entriesPerPage = 10;
let allRows = [];

// Get all table rows (excluding header and footer)
function initializePagination() {
    const tableBody = document.getElementById('tableBody');
    allRows = Array.from(tableBody.getElementsByTagName('tr'));
    
    // Set default entries per page
    document.getElementById('entriesPerPage').value = entriesPerPage;
    
    // Add event listener for entries per page change
    document.getElementById('entriesPerPage').addEventListener('change', function() {
        entriesPerPage = parseInt(this.value);
        currentPage = 1;
        displayPage();
    });
    
    displayPage();
}

function displayPage() {
    const startIndex = (currentPage - 1) * entriesPerPage;
    const endIndex = startIndex + entriesPerPage;
    
    // Hide all rows first
    allRows.forEach(row => row.style.display = 'none');
    
    // Show rows for current page
    for (let i = startIndex; i < endIndex && i < allRows.length; i++) {
        allRows[i].style.display = '';
        // Update row number
        const firstCell = allRows[i].getElementsByTagName('td')[0];
        if (firstCell) {
            firstCell.textContent = i + 1;
        }
    }
    
    updatePaginationInfo();
    updatePaginationControls();
}

function updatePaginationInfo() {
    const totalEntries = allRows.length;
    const startIndex = (currentPage - 1) * entriesPerPage + 1;
    const endIndex = Math.min(currentPage * entriesPerPage, totalEntries);
    
    const infoElement = document.getElementById('paginationInfo');
    infoElement.textContent = `Menampilkan ${startIndex} sampai ${endIndex} dari ${totalEntries} entri`;
}

function updatePaginationControls() {
    const totalPages = Math.ceil(allRows.length / entriesPerPage);
    const paginationControls = document.getElementById('paginationControls');
    
    paginationControls.innerHTML = '';
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">«</a>`;
    paginationControls.appendChild(prevLi);
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        const firstLi = document.createElement('li');
        firstLi.className = 'page-item';
        firstLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(1)">1</a>`;
        paginationControls.appendChild(firstLi);
        
        if (startPage > 2) {
            const dotsLi = document.createElement('li');
            dotsLi.className = 'page-item disabled';
            dotsLi.innerHTML = `<span class="page-link">...</span>`;
            paginationControls.appendChild(dotsLi);
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        paginationControls.appendChild(li);
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            const dotsLi = document.createElement('li');
            dotsLi.className = 'page-item disabled';
            dotsLi.innerHTML = `<span class="page-link">...</span>`;
            paginationControls.appendChild(dotsLi);
        }
        
        const lastLi = document.createElement('li');
        lastLi.className = 'page-item';
        lastLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a>`;
        paginationControls.appendChild(lastLi);
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">»</a>`;
    paginationControls.appendChild(nextLi);
}

function changePage(page) {
    const totalPages = Math.ceil(allRows.length / entriesPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        displayPage();
    }
    return false;
}

// Initialize pagination when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializePagination();
});

// Prepare data for jenis perkara chart
const jenisPerkaraData = {};
reportData.forEach(item => {
    if (jenisPerkaraData[item.JENIS_PERKARA]) {
        jenisPerkaraData[item.JENIS_PERKARA] += item.TOTAL;
    } else {
        jenisPerkaraData[item.JENIS_PERKARA] = item.TOTAL;
    }
});

const jenisPerkaraLabels = Object.keys(jenisPerkaraData);
const jenisPerkaraValues = Object.values(jenisPerkaraData);

// Colors for jenis perkara chart
const colors = [
    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', 
    '#FF9F40', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'
];

// Jenis Perkara Chart (Bar Chart)
const jenisPerkaraCtx = document.getElementById('jenisPerkaraChart').getContext('2d');
new Chart(jenisPerkaraCtx, {
    type: 'bar',
    data: {
        labels: jenisPerkaraLabels,
        datasets: [{
            label: 'Jumlah Kasus',
            data: jenisPerkaraValues,
            backgroundColor: colors.slice(0, jenisPerkaraLabels.length),
            borderColor: colors.slice(0, jenisPerkaraLabels.length),
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            },
            x: {
                ticks: {
                    maxRotation: 45,
                    minRotation: 0
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            title: {
                display: true,
                text: 'Histogram Distribusi Kasus per Jenis Perkara'
            }
        }
    }
});
</script>

<style>
@media print {
    .btn, .card-header .btn-group, .no-print {
        display: none !important;
    }
    
    .card {
        border: none !important;
        box-shadow: none !important;
    }
    
    .table {
        font-size: 12px;
    }
    
    .badge {
        color: #000 !important;
        background-color: #fff !important;
        border: 1px solid #000 !important;
    }
}
</style>
{% endblock %}
{% endblock %}